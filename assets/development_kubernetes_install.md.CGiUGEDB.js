import{_ as s,c as a,o as n,a4 as l}from"./chunks/framework.BIfEuBG4.js";const C=JSON.parse('{"title":"Install Kubernetes","description":"","frontmatter":{},"headers":[],"relativePath":"development/kubernetes/install.md","filePath":"development/kubernetes/install.md","lastUpdated":1701994294000}'),p={name:"development/kubernetes/install.md"},e=l(`<h1 id="install-kubernetes" tabindex="-1">Install Kubernetes <a class="header-anchor" href="#install-kubernetes" aria-label="Permalink to &quot;Install Kubernetes&quot;">​</a></h1><p>Login to one of master nodes.</p><p>Install packages before to start.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#546E7A;font-style:italic;"># enable community repo in /etc/apk/repositories</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">kubelet=~1.28</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">kubeadm=~1.28</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">kubeadm-bash-completion=~1.28</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><p>Before to install add modules <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" target="_blank" rel="noreferrer">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> tee</span><span style="color:#C3E88D;"> /etc/modules-load.d/k8s.conf</span></span>
<span class="line"><span style="color:#C3E88D;">overlay</span></span>
<span class="line"><span style="color:#C3E88D;">br_netfilter</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">modprobe</span><span style="color:#C3E88D;"> overlay</span></span>
<span class="line"><span style="color:#FFCB6B;">modprobe</span><span style="color:#C3E88D;"> br_netfilter</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic;"># sysctl params required by setup, params persist across reboots</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> tee</span><span style="color:#C3E88D;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="color:#C3E88D;">net.bridge.bridge-nf-call-iptables  = 1</span></span>
<span class="line"><span style="color:#C3E88D;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="color:#C3E88D;">net.ipv4.ip_forward                 = 1</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sysctl</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /etc/sysctl.d/k8s.conf</span></span></code></pre></div><p>Verify that settings are applied.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">lsmod</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> grep</span><span style="color:#C3E88D;"> br_netfilter</span></span>
<span class="line"><span style="color:#FFCB6B;">lsmod</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> grep</span><span style="color:#C3E88D;"> overlay</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sysctl</span><span style="color:#C3E88D;"> net.bridge.bridge-nf-call-iptables</span><span style="color:#C3E88D;"> net.bridge.bridge-nf-call-ip6tables</span><span style="color:#C3E88D;"> net.ipv4.ip_forward</span></span></code></pre></div><p>Close swap with <code>swapoff -a</code> and comment swap parition in <code>/etc/fstab</code></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> containerd</span><span style="color:#C3E88D;"> containerd-openrc</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">rc-update</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> ntpd</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-update</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> containerd</span><span style="color:#C3E88D;"> default</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-update</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> kubelet</span><span style="color:#C3E88D;"> default</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">rc-service</span><span style="color:#C3E88D;"> ntpd</span><span style="color:#C3E88D;"> start</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-service</span><span style="color:#C3E88D;"> containerd</span><span style="color:#C3E88D;"> start</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-service</span><span style="color:#C3E88D;"> kubelet</span><span style="color:#C3E88D;"> start</span></span></code></pre></div><blockquote><p>Preparation is completed and we can set this node as template.</p></blockquote><hr><blockquote><p>Cilium can handle kube-proxy so we don&#39;t need to install it.<br><code>--skip-phases=addon/kube-proxy</code></p></blockquote><p>Before to start, need to add load balancer to support HA.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">kubeadm</span><span style="color:#C3E88D;"> init</span><span style="color:#C3E88D;"> --control-plane-endpoint</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">cluster.kube-cluster:6443</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> --upload-certs</span><span style="color:#C3E88D;"> --skip-phases=addon/kube-proxy</span></span></code></pre></div><p>After that you will get this kind of output.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span>Your Kubernetes control-plane has initialized successfully!</span></span>
<span class="line"><span></span></span>
<span class="line"><span>To start using your cluster, you need to run the following as a regular user:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  mkdir -p $HOME/.kube</span></span>
<span class="line"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span>
<span class="line"><span>  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Alternatively, if you are the root user, you can run:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  export KUBECONFIG=/etc/kubernetes/admin.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You should now deploy a pod network to the cluster.</span></span>
<span class="line"><span>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span></span>
<span class="line"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You can now join any number of the control-plane node running the following command on each as root:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  kubeadm join cluster.kube-cluster:6443 --token 84r14X.XXXXXXXXXXXXXXXX \\</span></span>
<span class="line"><span>	--discovery-token-ca-cert-hash sha256:9806b525aa16XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX \\</span></span>
<span class="line"><span>	--control-plane --certificate-key a373ab55fa13697XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!</span></span>
<span class="line"><span>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use</span></span>
<span class="line"><span>&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Then you can join any number of worker nodes by running the following on each as root:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kubeadm join cluster.kube-cluster:6443 --token 84r14X.XXXXXXXXXXXXXXXX \\</span></span>
<span class="line"><span>	--discovery-token-ca-cert-hash sha256:9806b525aa16XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></span></code></pre></div><p>Record this in management machine.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#EEFFFF;"> $HOME</span><span style="color:#C3E88D;">/.kube</span></span>
<span class="line"><span style="color:#FFCB6B;">scp</span><span style="color:#C3E88D;"> root@master1:/etc/kubernetes/admin.conf</span><span style="color:#EEFFFF;"> $HOME</span><span style="color:#C3E88D;">/.kube/config</span></span></code></pre></div><h2 id="network" tabindex="-1">Network <a class="header-anchor" href="#network" aria-label="Permalink to &quot;Network&quot;">​</a></h2><p>Download cilium cli in management machine.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#EEFFFF;">CILIUM_CLI_VERSION</span><span style="color:#89DDFF;">=$(</span><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> -s</span><span style="color:#C3E88D;"> https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#EEFFFF;">CLI_ARCH</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">amd64</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;"> [</span><span style="color:#89DDFF;"> &quot;$(</span><span style="color:#FFCB6B;">uname</span><span style="color:#C3E88D;"> -m</span><span style="color:#89DDFF;">)&quot;</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">aarch64</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ];</span><span style="color:#89DDFF;font-style:italic;"> then</span><span style="color:#EEFFFF;"> CLI_ARCH</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">arm64</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;font-style:italic;"> fi</span></span>
<span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> -L</span><span style="color:#C3E88D;"> --fail</span><span style="color:#C3E88D;"> --remote-name-all</span><span style="color:#C3E88D;"> https://github.com/cilium/cilium-cli/releases/download/</span><span style="color:#89DDFF;">\${</span><span style="color:#EEFFFF;">CILIUM_CLI_VERSION</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">/cilium-linux-</span><span style="color:#89DDFF;">\${</span><span style="color:#EEFFFF;">CLI_ARCH</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.tar.gz{,.sha256sum}</span></span>
<span class="line"><span style="color:#FFCB6B;">sha256sum</span><span style="color:#C3E88D;"> -c</span><span style="color:#C3E88D;"> cilium-linux-</span><span style="color:#89DDFF;">\${</span><span style="color:#EEFFFF;">CLI_ARCH</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.tar.gz.sha256sum</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#C3E88D;"> xzvfC</span><span style="color:#C3E88D;"> cilium-linux-</span><span style="color:#89DDFF;">\${</span><span style="color:#EEFFFF;">CLI_ARCH</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.tar.gz</span><span style="color:#C3E88D;"> /usr/local/bin</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#C3E88D;"> cilium-linux-</span><span style="color:#89DDFF;">\${</span><span style="color:#EEFFFF;">CLI_ARCH</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.tar.gz{,.sha256sum}</span></span></code></pre></div><p>Run install command, it will install on kubectl context.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cilium</span><span style="color:#C3E88D;"> install</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cilium</span><span style="color:#C3E88D;"> status</span></span></code></pre></div><p>Add CNI plugin.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> -fkSLO</span><span style="color:#C3E88D;"> https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz</span></span>
<span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /usr/libexec/cni</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#C3E88D;"> -C</span><span style="color:#C3E88D;"> /usr/libexec/cni</span><span style="color:#C3E88D;"> -xzf</span><span style="color:#C3E88D;"> cni-plugins-linux-amd64-v1.4.0.tgz</span></span></code></pre></div><p>Or just for cilium:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /usr/libexec/cni</span></span>
<span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#C3E88D;"> /opt/cni/bin/</span><span style="color:#EEFFFF;">*</span><span style="color:#C3E88D;"> /usr/libexec/cni/</span></span></code></pre></div><p>Before to join the node make shared of folders.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mount</span><span style="color:#C3E88D;"> --make-rshared</span><span style="color:#C3E88D;"> /run</span></span>
<span class="line"><span style="color:#FFCB6B;">mount</span><span style="color:#C3E88D;"> --make-rshared</span><span style="color:#C3E88D;"> /sys</span></span></code></pre></div><p>Make it persistent.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> &gt;</span><span style="color:#C3E88D;"> /etc/local.d/rc.local</span></span>
<span class="line"><span style="color:#C3E88D;">#!/bin/sh</span></span>
<span class="line"><span style="color:#C3E88D;">/bin/mount --make-rshared /run</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">chmod</span><span style="color:#C3E88D;"> +x</span><span style="color:#C3E88D;"> /etc/local.d/rc.local</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-update</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-update</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> local</span><span style="color:#C3E88D;"> boot</span></span></code></pre></div><h3 id="hubble" tabindex="-1">Hubble <a class="header-anchor" href="#hubble" aria-label="Permalink to &quot;Hubble&quot;">​</a></h3><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cilium</span><span style="color:#C3E88D;"> hubble</span><span style="color:#C3E88D;"> enable</span></span></code></pre></div><p>Check UI</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cilium</span><span style="color:#C3E88D;"> hubble</span><span style="color:#C3E88D;"> ui</span></span>
<span class="line"><span style="color:#546E7A;font-style:italic;">#or</span></span>
<span class="line"><span style="color:#FFCB6B;">kubectl</span><span style="color:#C3E88D;"> port-forward</span><span style="color:#C3E88D;"> -n</span><span style="color:#C3E88D;"> kube-system</span><span style="color:#C3E88D;"> svc/hubble-ui</span><span style="color:#C3E88D;"> --address</span><span style="color:#F78C6C;"> 0.0.0.0</span><span style="color:#C3E88D;"> 12000:80</span></span></code></pre></div>`,38),o=[e];function t(c,r,i,d,y,F){return n(),a("div",null,o)}const D=s(p,[["render",t]]);export{C as __pageData,D as default};
