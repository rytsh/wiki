import{_ as s,o as a,c as n,R as e}from"./chunks/framework.07BXFssY.js";const u=JSON.parse('{"title":"Management Machine","description":"","frontmatter":{},"headers":[],"relativePath":"development/kubernetes/management.md","filePath":"development/kubernetes/management.md","lastUpdated":1701994968000}'),l={name:"development/kubernetes/management.md"},o=e(`<h1 id="management-machine" tabindex="-1">Management Machine <a class="header-anchor" href="#management-machine" aria-label="Permalink to &quot;Management Machine&quot;">​</a></h1><p>For creating a cluster, first we need a management machine to setup dhcp, pxe, dns, etc.<br> I use <code>alpine linux</code> for this. It is a very small linux distro and perfect for this job.</p><p>First give the iso URL to the proxmox and it will download it.</p><p>When creating the virtual machine, give it 2 cores and 1GB of ram.<br> Also give it a 32GB disk, (based on kernel setting sata can view it).</p><p>For network, give it 2 network cards. One for the internet and one for the internal network.<br> Use Intel E1000 for both of them.</p><p>And our cluster machines just will be in the internal network.</p><p>For creating internal network just create a new bridge and give it a name and leave the gateway empty.</p><p>I use to go to internet with the management machine.</p><h4 id="network-config" tabindex="-1">Network Config <a class="header-anchor" href="#network-config" aria-label="Permalink to &quot;Network Config&quot;">​</a></h4><p>Setting manual IP address for the management machine.</p><p>In my case eth0 is the internet and eth1 is the internal network.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#C3E88D;"> /etc/network/interfaces</span><span style="color:#EEFFFF;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">auto</span><span style="color:#C3E88D;"> lo</span></span>
<span class="line"><span style="color:#FFCB6B;">iface</span><span style="color:#C3E88D;"> lo</span><span style="color:#C3E88D;"> inet</span><span style="color:#C3E88D;"> loopback</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">auto</span><span style="color:#C3E88D;"> eth0</span></span>
<span class="line"><span style="color:#FFCB6B;">iface</span><span style="color:#C3E88D;"> eth0</span><span style="color:#C3E88D;"> inet</span><span style="color:#C3E88D;"> static</span></span>
<span class="line"><span style="color:#FFCB6B;">        address</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.68.220/24</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">auto</span><span style="color:#C3E88D;"> eth1</span></span>
<span class="line"><span style="color:#FFCB6B;">iface</span><span style="color:#C3E88D;"> eth1</span><span style="color:#C3E88D;"> inet</span><span style="color:#C3E88D;"> static</span></span>
<span class="line"><span style="color:#FFCB6B;">        address</span><span style="color:#F78C6C;"> 10.10</span><span style="color:#C3E88D;">.10.1/24</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">up</span><span style="color:#C3E88D;"> ip</span><span style="color:#C3E88D;"> route</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> default</span><span style="color:#C3E88D;"> via</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.68.1</span></span></code></pre></div><p>And need to restart the network service.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">rc-service</span><span style="color:#C3E88D;"> networking</span><span style="color:#C3E88D;"> restart</span></span></code></pre></div><p>Inside of the <code>/etc/resolv.conf</code> file, we set search name.<br> To set directly with command line use this command:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">setup-dns</span><span style="color:#C3E88D;"> -s</span><span style="color:#C3E88D;"> kube-cluster</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#C3E88D;"> /etc/resolv.conf</span></span>
<span class="line"><span style="color:#FFCB6B;">search</span><span style="color:#C3E88D;"> cluster.kube-cluster</span><span style="color:#C3E88D;"> kube-cluster</span></span>
<span class="line"><span style="color:#FFCB6B;">nameserver</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.68.1</span></span></code></pre></div><p>Also need to set route for connecting to internet, if you didn&#39;t set in network config.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">ip</span><span style="color:#C3E88D;"> route</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> default</span><span style="color:#C3E88D;"> via</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.68.1</span></span></code></pre></div><p>We will change nameserver later and use our own dns server.</p><p>I used in dhcpd server <code>kube-cluster</code> as domain name so <code>management.kube-cluster</code> will be the management machine&#39;s hostname.</p><h3 id="ssh" tabindex="-1">SSH <a class="header-anchor" href="#ssh" aria-label="Permalink to &quot;SSH&quot;">​</a></h3><p>Inside of the /etc/ssh/sshd_config file, we need to change the <code>PermitRootLogin</code> to <code>yes</code> and restart the service.<br> After pushing the ssh key to the management machine, we can connect to it with ssh and close the root login.</p><blockquote><p>If you can directly to push public-key to the management machine, that would be better!</p></blockquote><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#546E7A;font-style:italic;"># push the ssh public key to the management machine</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh-copy-id</span><span style="color:#C3E88D;"> root@192.168.68.220</span></span></code></pre></div><p>Now we can connect to the management machine with ssh.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#C3E88D;"> root@192.168.68.220</span></span></code></pre></div><p>And switch <code>PermitRootLogin</code> to <code>prohibit-password</code> and restart the service.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">rc-service</span><span style="color:#C3E88D;"> sshd</span><span style="color:#C3E88D;"> restart</span></span></code></pre></div><p>Change the motd message.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#C3E88D;"> /etc/motd</span></span></code></pre></div><p>Connect always with SSH after this step.</p><h3 id="ssh-key" tabindex="-1">SSH Key <a class="header-anchor" href="#ssh-key" aria-label="Permalink to &quot;SSH Key&quot;">​</a></h3><p>Generate ssh key for the management machine.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">ssh-keygen</span></span></code></pre></div><blockquote><p>Copy the public key in the <code>/var/boot</code> directory we will use it while creating the machines.</p></blockquote><h3 id="ip-forward" tabindex="-1">IP Forward <a class="header-anchor" href="#ip-forward" aria-label="Permalink to &quot;IP Forward&quot;">​</a></h3><p>Enable ip forwarding so we can connect to the internet with using this machine from the internal network.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#C3E88D;">  net.ipv4.ip_forward</span><span style="color:#C3E88D;"> =</span><span style="color:#F78C6C;"> 1</span><span style="color:#89DDFF;"> &gt;&gt;</span><span style="color:#C3E88D;"> /etc/sysctl.conf</span></span>
<span class="line"><span style="color:#FFCB6B;">sysctl</span><span style="color:#C3E88D;"> -p</span></span>
<span class="line"><span style="color:#FFCB6B;">sysctl</span><span style="color:#C3E88D;"> -a</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> grep</span><span style="color:#C3E88D;"> net.ipv4.ip_forward</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic;">## enable NAT</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> iptables</span></span>
<span class="line"><span style="color:#FFCB6B;">rc-update</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> iptables</span><span style="color:#C3E88D;"> default</span></span>
<span class="line"><span style="color:#546E7A;font-style:italic;"># eth1 is the internal interface</span></span>
<span class="line"><span style="color:#FFCB6B;">iptables</span><span style="color:#C3E88D;"> -A</span><span style="color:#C3E88D;"> FORWARD</span><span style="color:#C3E88D;"> -i</span><span style="color:#C3E88D;"> eth1</span><span style="color:#C3E88D;"> -j</span><span style="color:#C3E88D;"> ACCEPT</span></span>
<span class="line"><span style="color:#546E7A;font-style:italic;"># eth0 is the external interface (connected to the internet)</span></span>
<span class="line"><span style="color:#FFCB6B;">iptables</span><span style="color:#C3E88D;"> -t</span><span style="color:#C3E88D;"> nat</span><span style="color:#C3E88D;"> -A</span><span style="color:#C3E88D;"> POSTROUTING</span><span style="color:#C3E88D;"> -o</span><span style="color:#C3E88D;"> eth0</span><span style="color:#C3E88D;"> -j</span><span style="color:#C3E88D;"> MASQUERADE</span></span>
<span class="line"><span style="color:#FFCB6B;">/etc/init.d/iptables</span><span style="color:#C3E88D;"> save</span></span></code></pre></div><h3 id="dns" tabindex="-1">DNS <a class="header-anchor" href="#dns" aria-label="Permalink to &quot;DNS&quot;">​</a></h3><p>Go and install <a href="/wiki/tools/server/dns.html">coredns</a>.</p><h3 id="tftp" tabindex="-1">TFTP <a class="header-anchor" href="#tftp" aria-label="Permalink to &quot;TFTP&quot;">​</a></h3><p>Go and install <a href="/wiki/tools/server/tftp.html">tftp</a>.</p><p><a href="https://wiki.alpinelinux.org/wiki/Netboot_Alpine_Linux_using_iPXE" target="_blank" rel="noreferrer">https://wiki.alpinelinux.org/wiki/Netboot_Alpine_Linux_using_iPXE</a></p><p>For setup ipxe, we need to add <code>boot.ipxe</code> file to the <code>/var/tftpboot/</code> directory.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme vp-code"><code><span class="line"><span>#!ipxe</span></span>
<span class="line"><span></span></span>
<span class="line"><span>set base-url http://10.10.10.1:7080</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kernel \${base-url}/boot/vmlinuz-virt console=tty0 modules=loop,squashfs quiet nomodeset alpine_repo=https://dl-cdn.alpinelinux.org/alpine/v3.18/main modloop=http://10.10.10.1:7080/boot/modloop-virt</span></span>
<span class="line"><span>initrd \${base-url}/boot/initramfs-virt</span></span>
<span class="line"><span>boot</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /var/boot</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#C3E88D;"> /var/boot</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> -fSL</span><span style="color:#C3E88D;"> https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/alpine-netboot-3.18.5-x86_64.tar.gz</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> tar</span><span style="color:#C3E88D;"> -xz</span><span style="color:#C3E88D;"> --overwrite</span></span></code></pre></div><p>Now we need to serve this directory to <code>0.0.0.0:7080</code></p><p>With <a href="https://worldline-go.github.io/turna/introduction/getting-started.html#linux" target="_blank" rel="noreferrer">turna</a>, we can do this.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#546E7A;font-style:italic;"># install it to /bin/ directory</span></span>
<span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#C3E88D;"> -fSL</span><span style="color:#C3E88D;"> https://github.com/worldline-go/turna/releases/latest/download/turna_Linux_x86_64.tar.gz</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> tar</span><span style="color:#C3E88D;"> -xz</span><span style="color:#C3E88D;"> --overwrite</span><span style="color:#C3E88D;"> -C</span><span style="color:#C3E88D;"> /bin/</span><span style="color:#C3E88D;"> turna</span></span>
<span class="line"></span>
<span class="line"><span style="color:#546E7A;font-style:italic;"># add config to /var/boot/turna.yaml</span></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> &gt;</span><span style="color:#EEFFFF;"> /var/boot/turna.yaml</span></span>
<span class="line"><span style="color:#C3E88D;">server:</span></span>
<span class="line"><span style="color:#C3E88D;">  entrypoints:</span></span>
<span class="line"><span style="color:#C3E88D;">    web:</span></span>
<span class="line"><span style="color:#C3E88D;">      address: &quot;:7080&quot;</span></span>
<span class="line"><span style="color:#C3E88D;">  http:</span></span>
<span class="line"><span style="color:#C3E88D;">    middlewares:</span></span>
<span class="line"><span style="color:#C3E88D;">      folder:</span></span>
<span class="line"><span style="color:#C3E88D;">        folder:</span></span>
<span class="line"><span style="color:#C3E88D;">          path: /var/boot</span></span>
<span class="line"><span style="color:#C3E88D;">          browse: true</span></span>
<span class="line"><span style="color:#C3E88D;">    routers:</span></span>
<span class="line"><span style="color:#C3E88D;">      boot:</span></span>
<span class="line"><span style="color:#C3E88D;">        path: /*</span></span>
<span class="line"><span style="color:#C3E88D;">        middlewares:</span></span>
<span class="line"><span style="color:#C3E88D;">          - folder</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span></code></pre></div><p>Now we can start <code>turna</code> server</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#EEFFFF;">CONFIG_FILE</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/var/boot/turna.yaml</span><span style="color:#FFCB6B;"> turna</span></span></code></pre></div><p>We enabled the browse option so we can check the files from the browser.</p><h3 id="dhcpd" tabindex="-1">DHCPD <a class="header-anchor" href="#dhcpd" aria-label="Permalink to &quot;DHCPD&quot;">​</a></h3><p>Go and install <a href="/wiki/tools/server/dhcpd.html">dhcpd</a> after that setup same as network config.</p><h3 id="load-balancer" tabindex="-1">Load Balancer <a class="header-anchor" href="#load-balancer" aria-label="Permalink to &quot;Load Balancer&quot;">​</a></h3><p>Go and install <a href="/wiki/tools/server/load_balancer.html">haproxy</a>.</p><h2 id="add-machines-to-the-cluster" tabindex="-1">Add machines to the cluster <a class="header-anchor" href="#add-machines-to-the-cluster" aria-label="Permalink to &quot;Add machines to the cluster&quot;">​</a></h2><p>Create new machine but just give 1 network for internal bridge and set mac address manually based on DHCPD config.</p><p>When we setup the correctly tftpd and dhcpd, we can see the ipxe will work and we can see the alpine linux boot screen.</p><h2 id="install-tools" tabindex="-1">Install Tools <a class="header-anchor" href="#install-tools" aria-label="Permalink to &quot;Install Tools&quot;">​</a></h2><p>kubectl install in with edge repository.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code"><code><span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#C3E88D;"> http://dl-cdn.alpinelinux.org/alpine/edge/community</span><span style="color:#89DDFF;"> &gt;&gt;</span><span style="color:#C3E88D;"> /etc/apk/repositories</span></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> update</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">apk</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> kubectl</span></span></code></pre></div>`,63),t=[o];function p(c,r,i,d,h,y){return a(),n("div",null,t)}const m=s(l,[["render",p]]);export{u as __pageData,m as default};
