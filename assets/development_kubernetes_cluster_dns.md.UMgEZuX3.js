import{_ as a,c as n,a2 as l,o as p}from"./chunks/framework.BQmytedh.js";const d=JSON.parse('{"title":"Core DNS","description":"","frontmatter":{},"headers":[],"relativePath":"development/kubernetes/cluster/dns.md","filePath":"development/kubernetes/cluster/dns.md","lastUpdated":1735492606000}'),e={name:"development/kubernetes/cluster/dns.md"};function o(t,s,c,r,i,y){return p(),n("div",null,s[0]||(s[0]=[l(`<h1 id="core-dns" tabindex="-1">Core DNS <a class="header-anchor" href="#core-dns" aria-label="Permalink to &quot;Core DNS&quot;">​</a></h1><p>Setup a core DNS server locally to reach all of our gateways without any problem.</p><p>In here we transfer all DNS solution of <code>*.kube.com</code> to our cilium gateway which is <code>10.0.10.0</code>.<br> Others will use our WSL&#39;s DNS address which is I get from <code>cat /etc/resolv.conf</code> command.</p><p>Create locahost certificate</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mkcert</span><span style="color:#C3E88D;"> -key-file</span><span style="color:#C3E88D;"> key.pem</span><span style="color:#C3E88D;"> -cert-file</span><span style="color:#C3E88D;"> cert.pem</span><span style="color:#C3E88D;"> localhost</span></span>
<span class="line"><span style="color:#546E7A;font-style:italic;"># copy CA public key as well</span></span>
<span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#89DDFF;"> $(</span><span style="color:#FFCB6B;">mkcert</span><span style="color:#C3E88D;"> -CAROOT</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/rootCA.pem</span><span style="color:#C3E88D;"> .</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> &gt;</span><span style="color:#C3E88D;"> Corefile</span></span>
<span class="line"><span style="color:#C3E88D;">kube.com {</span></span>
<span class="line"><span style="color:#C3E88D;">    file /etc/coredns/cluster.kube</span></span>
<span class="line"><span style="color:#C3E88D;">    reload</span></span>
<span class="line"><span style="color:#C3E88D;">    errors</span></span>
<span class="line"><span style="color:#C3E88D;">    log</span></span>
<span class="line"><span style="color:#C3E88D;">    cache 30</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">. {</span></span>
<span class="line"><span style="color:#C3E88D;">    forward . 10.255.255.254 {</span></span>
<span class="line"><span style="color:#C3E88D;">        tls_servername dns.google</span></span>
<span class="line"><span style="color:#C3E88D;">    }</span></span>
<span class="line"><span style="color:#C3E88D;">    cache 30</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">https://.:5553 {</span></span>
<span class="line"><span style="color:#C3E88D;">    tls cert.pem key.pem {</span></span>
<span class="line"><span style="color:#C3E88D;">        client_auth nocert</span></span>
<span class="line"><span style="color:#C3E88D;">    }</span></span>
<span class="line"><span style="color:#C3E88D;">    forward . /etc/resolv.conf</span></span>
<span class="line"><span style="color:#C3E88D;">    errors</span></span>
<span class="line"><span style="color:#C3E88D;">    log</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#89DDFF;"> &gt;</span><span style="color:#C3E88D;"> kube.com</span></span>
<span class="line"><span style="color:#C3E88D;">@ 3600 IN SOA kube.com. admin.kube.com. (</span></span>
<span class="line"><span style="color:#C3E88D;">    1          ; serial</span></span>
<span class="line"><span style="color:#C3E88D;">    7200       ; refresh (2 hours)</span></span>
<span class="line"><span style="color:#C3E88D;">    3600       ; retry (1 hour)</span></span>
<span class="line"><span style="color:#C3E88D;">    1209600    ; expire (2 weeks)</span></span>
<span class="line"><span style="color:#C3E88D;">    3600       ; minimum (1 hour)</span></span>
<span class="line"><span style="color:#C3E88D;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">*     IN A     10.0.10.0</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span></code></pre></div><p>Now run it</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> run</span><span style="color:#C3E88D;"> -d</span><span style="color:#C3E88D;"> --restart=always</span><span style="color:#C3E88D;"> --name=coredns</span><span style="color:#EEFFFF;"> \\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#89DDFF;"> $(</span><span style="color:#82AAFF;">pwd</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/Corefile:/Corefile</span><span style="color:#C3E88D;"> -v</span><span style="color:#89DDFF;"> $(</span><span style="color:#82AAFF;">pwd</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/kube.com/etc/coredns/kube.com</span><span style="color:#EEFFFF;"> \\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#89DDFF;"> $(</span><span style="color:#82AAFF;">pwd</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/rootCA.pem:/ca.pem</span><span style="color:#C3E88D;"> -v</span><span style="color:#89DDFF;"> $(</span><span style="color:#82AAFF;">pwd</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/cert.pem:/cert.pem</span><span style="color:#C3E88D;"> -v</span><span style="color:#89DDFF;"> $(</span><span style="color:#82AAFF;">pwd</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/key.pem:/key.pem</span><span style="color:#EEFFFF;"> \\</span></span>
<span class="line"><span style="color:#C3E88D;">  --dns=127.0.0.1</span><span style="color:#EEFFFF;"> \\</span></span>
<span class="line"><span style="color:#C3E88D;">  -p</span><span style="color:#C3E88D;"> 0.0.0.0:5553:5553</span><span style="color:#EEFFFF;"> \\</span></span>
<span class="line"><span style="color:#C3E88D;">  coredns/coredns:1.12.0</span></span></code></pre></div><p>Test with kdig</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> apt</span><span style="color:#C3E88D;"> install</span><span style="color:#C3E88D;"> knot-dnsutils</span></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">kdig</span><span style="color:#C3E88D;"> -d</span><span style="color:#C3E88D;"> @localhost</span><span style="color:#C3E88D;"> -p</span><span style="color:#F78C6C;"> 5553</span><span style="color:#C3E88D;"> +tls-ca=/rootCA.pem</span><span style="color:#C3E88D;"> +tls-hostname=localhost</span><span style="color:#C3E88D;"> wikipedia.org</span></span></code></pre></div><h2 id="forward-10-0-10-0-24-to-cilium" tabindex="-1">Forward 10.0.10.0/24 to cilium <a class="header-anchor" href="#forward-10-0-10-0-24-to-cilium" aria-label="Permalink to &quot;Forward 10.0.10.0/24 to cilium&quot;">​</a></h2><blockquote><p>TODO Still checking</p></blockquote><p>First we need to forward all traffic to cilium gateway.</p><p>Do it in node:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">ip</span><span style="color:#C3E88D;"> route</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> 10.0.10.0/24</span><span style="color:#C3E88D;"> via</span><span style="color:#89DDFF;"> $(</span><span style="color:#FFCB6B;">kubectl</span><span style="color:#C3E88D;"> get</span><span style="color:#C3E88D;"> nodes</span><span style="color:#C3E88D;"> -o</span><span style="color:#C3E88D;"> jsonpath=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{.items[0].status.addresses[?(@.type==&quot;InternalIP&quot;)].address}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">sysctl</span><span style="color:#C3E88D;"> -w</span><span style="color:#C3E88D;"> net.ipv4.ip_forward=</span><span style="color:#F78C6C;">1</span></span></code></pre></div><p>Second we need to tell in our local machine to forward all traffic to that machine.</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme vp-code" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">ip</span><span style="color:#C3E88D;"> route</span><span style="color:#C3E88D;"> add</span><span style="color:#C3E88D;"> 10.0.10.0/24</span><span style="color:#C3E88D;"> via</span><span style="color:#89DDFF;"> $(</span><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> inspect</span><span style="color:#C3E88D;"> -f</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> kind-control-plane</span><span style="color:#89DDFF;">)</span></span></code></pre></div>`,19)]))}const C=a(e,[["render",o]]);export{d as __pageData,C as default};
